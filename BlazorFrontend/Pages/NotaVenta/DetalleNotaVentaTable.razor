@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using global::Services.LoteService
@inject LoteService LoteService

<MudTable Hover="true"
          Dense="true"
          RowsPerPage="4"
          Bordered="true"
          Elevation="2"
          Striped="true"
          Class="mt-4 fade-in"
          Height="380px"
          ApplyButtonPosition="TableApplyButtonPosition.Start"
          EditTrigger="TableEditTrigger.RowClick"
          Style="border-radius: 15px;"
          Items="DetalleCompra"
          CommitEditTooltip="Guardar cambios"
          CancelEditTooltip="Cancelar cambios"
          IsEditRowSwitchingBlocked="true"
          CanCancelEdit="true">
    <HeaderContent>
        <MudTh>Articulo</MudTh>
        <MudTh>Lote</MudTh>
        <MudTh>Cantidad</MudTh>
        <MudTh Style="text-align: right">Precio</MudTh>
        <MudTh Style="text-align: right">Subtotal</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@GetArticuloName(context.IdArticulo)</MudTd>
        <MudTd>@context.NroLote</MudTd>
        <MudTd>@context.Cantidad</MudTd>
        <MudTd Style="text-align: right">
            @context.PrecioVenta.ToString("F2")
        </MudTd>
        <MudTd Style="text-align: right;">
            @((context.Cantidad * context.PrecioVenta).ToString("F2"))
        </MudTd>
        <MudTd>
            <MudTooltip Text="Eliminar">
                <MudIconButton Size="Size.Small"
                               Icon="@Icons.Material.Rounded.Delete"
                               Color="Color.Error"
                               OnClick="() => DeleteEntry(context)"/>
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd>
            <MudAutocomplete Value="SelectedArticulo"
                             T="string"
                             Label="Aritculos"
                             HelperText="Seleccione un articulo"
                             Required="true"
                             RequiredError="Debe seleccionar un articulo"
                             SearchFunc="Search1"
                             ValueChanged="@(v => UpdateSelectedArticulo(v))"
                             Variant="Variant.Text"
                             Clearable="true"
                             Margin="Margin.Dense"/>
        </MudTd>
        <MudTd>
            <MudSelect T="int"
                       @bind-Value="@context.NroLote"
                       Label="Nro Lote"
                       Variant="Variant.Text"
                       Immediate="true"
                       Style="width: 150px;"
                       Margin="Margin.Dense">
                @if (NroLotes != null)
                {
                    @foreach (var nroLote in NroLotes)
                    {
                        <MudSelectItem Value="@nroLote">
                            @nroLote
                        </MudSelectItem>
                    }
                }
            </MudSelect>
        </MudTd>
        <MudTd>
            <MudTextField T="int"
                          @bind-Value="@context.Cantidad"
                          Label="Cantidad"
                          Variant="Variant.Text"
                          Immediate="true"
                          Required="true"
                          RequiredError="Debe ingresar una cantidad"
                          ErrorText="No se permiten palabras o numeros"
                          Class="right-aligned-input"
                          HelperText="@StockMessage"
                          Margin="Margin.Dense"/>
        </MudTd>
        <MudTd/>
        <MudTd/>
        <MudTd/>
    </RowEditingTemplate>
    <FooterContent>
        <MudTh/>
        <MudTh/>
        <MudTh/>
        <MudTh/>
        <MudTh Style="text-align: right">
            Total: @Total.ToString("F2")
        </MudTh>
        <MudTh/>
    </FooterContent>
</MudTable>