@page "/articulo/{idempresa:int}"
@using global::Services.CategoriaService
@using global::Services.ArticuloService
@using global::Services.ArticuloCategoriaService
@inject CategoriaService CategoriaService
@inject NavigationManager NavigationManager
@inject ArticuloService ArticuloService
@inject ArticuloCategoriaService ArticuloCategoriaService
@inject IDialogService DialogService
@layout MonedaDashBoardLayout

<NavBarComponent IdEmpresa="@IdEmpresa"/>

<MudStack Row="true"
          AlignItems="AlignItems.Center"
          Justify="Justify.SpaceBetween"
          Spacing="6"
          Style="margin-right: 0;">
    <MudText Align="Align.Start" Typo="Typo.h5" GutterBottom="true">
        Lista de articulos
    </MudText>
    <MudButton Variant="Variant.Filled"
               Color="Color.Success"
               StartIcon="@Icons.Material.Rounded.LibraryAdd"
               Class="mb-4 rounded-pill"
               OnClick="@ShowCrearArticulo"
               Style="justify-self: flex-end; align-self: center">
        <MudText Typo="Typo.button">
            Agregar Articulo
        </MudText>
    </MudButton>
</MudStack>

<MudDivider DividerType="DividerType.Middle"
            Light="false"
            Style="border-top-width: 3px;"
            Class="mb-5"/>

<MudTable Items="Articulos"
          Hover="true"
          Striped="true"
          Bordered="true"
          Style="border-radius: 15px; margin-right: 0;"
          Elevation="4"
          Loading="IsLoading"
          LoadingProgressColor="Color.Info"
          RowsPerPage="5"
          Filter="new Func<ArticuloDto, bool>(FilterFunc1)"
          @ref="@_table">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Busque articulos por nombre o descripcion</MudText>
        <MudSpacer/>
        <MudTextField @bind-Value="SearchString"
                      Placeholder="Buscar"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      IconSize="Size.Medium"
                      Immediate="true"
                      DebounceInterval="1"
                      Class="mt-0"/>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Nombre</MudTh>
        <MudTh>Descripcion</MudTh>
        <MudTh>Stock</MudTh>
        <MudTh>Precio de Venta</MudTh>
        <MudTh>Categorias</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Nombre</MudTd>
        <MudTd>@context.Descripcion</MudTd>
        <MudTd>@context.Cantidad</MudTd>
        <MudTd Style="text-align: right">
            @context.PrecioVenta.ToString("F2")
        </MudTd>
        <MudTd>
            @{
                if (_articuloCategorias.TryGetValue(context.IdArticulo, out var categorias))
                {
                    foreach (var categoria in categorias)
                    {
                        <MudChip Size="Size.Small"
                                 Color="Color.Primary"
                                 Variant="Variant.Filled">
                            @categoria
                        </MudChip>
                    }
                }
            }
        </MudTd>
        <MudTd>
            <MudTooltip Text="Editar" ShowOnClick="false" ShowOnFocus="false">
                <MudIconButton Icon="@Icons.Material.Rounded.Edit"
                               Color="Color.Warning"
                               Size="Size.Small"
                               OnClick="() => ShowEditarModal(context)"/>
            </MudTooltip>
            <MudTooltip Text="Eliminar articulo" ShowOnClick="false" ShowOnFocus="false">
                <MudIconButton Icon="@Icons.Material.Rounded.Delete"
                               Color="Color.Error"
                               Size="Size.Small"
                               OnClick="() => OpenEliminarArticulo(context.IdArticulo)"/>
            </MudTooltip>
            <MudTooltip Text="Ver lotes" ShowOnClick="false" ShowOnFocus="false">
                <MudIconButton Icon="@Icons.Material.Rounded.Notes"
                               Color="Color.Dark"
                               Size="Size.Small"
                               OnClick="() => OpenLotePerArticulo(context.IdArticulo)"/>
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudPagination SelectedChanged="PageChanged"
                           Count="@((_table.GetFilteredItemsCount() + _table.RowsPerPage - 1) / _table.RowsPerPage)"
                           Class="pa-4"
                           ShowFirstButton="true"
                           ShowLastButton="true"/>
        </MudStack>
    </PagerContent>
</MudTable>