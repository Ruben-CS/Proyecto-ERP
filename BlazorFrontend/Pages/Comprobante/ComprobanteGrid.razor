@page "/comprobantegrid/{idempresa:int}"
@using global::Services.EmpresaMonedaService
@using global::Services.Moneda
@using global::Services.Comprobante
@using Modelos.Models.Enums
@inject EmpresaMonedaService EmpresaMonedaService
@inject MonedaService MonedaService
@layout ComprobanteLayout
@inject IDialogService DialogService
@inject ComprobanteService ComprobanteService
@inject HttpClient HttpClient
@inject ISnackbar Snackbar


<NavBarComponent IdEmpresa="@IdEmpresa"/>

<MudText Typo="Typo.h4" GutterBottom="true">Datos del comprobante</MudText>

<MudPaper Elevation="1" Class="p-3">
    <MudGrid Spacing="2" Justify="Justify.Center">
        <MudItem xs="12" sm="4">
            <MudTextField Variant="Variant.Outlined"
                          Label="Serie"
                          T="string"
                          @bind-Value="SerieString"
                          Disabled="true"
                          Margin="Margin.Dense"/>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudDatePicker Variant="Variant.Outlined"
                           Label="Fecha"
                           @bind-Date="@Fecha"
                           Margin="Margin.Dense"/>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudSelect Variant="Variant.Outlined"
                       Label="Tipo de comprobante"
                       @bind-Value="SelectedTipoComprobante"
                       T="string"
                       Margin="Margin.Dense"
                       Dense="true">
                @foreach (var type in ComprobanteTypes)
                {
                    <MudSelectItem Value="@type">@type</MudSelectItem>
                }
            </MudSelect>

        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField @bind-Value="@TipoDeCambioString"
                          Label="Tipo de cambio"
                          Class="right-aligned-input"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"/>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudSelect Variant="Variant.Outlined"
                       Label="Moneda"
                       @bind-Value="SelectedEmpresaMoneda"
                       T="string"
                       Margin="Margin.Dense"
                       Dense="true">
                @foreach (var moneda in MonedasDeLaEmpresa)
                {
                    <MudSelectItem Value="@moneda!.Nombre">
                        @moneda.Nombre
                    </MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudSelect Variant="Variant.Outlined"
                       Label="Estado"
                       T="string"
                       Disabled="true"
                       bind-Text="@EstadoComprobante.Abierto.ToString()"
                       Placeholder="@EstadoComprobante.Abierto.ToString()"
                       Margin="Margin.Dense"
                       Dense="true">
            </MudSelect>
        </MudItem>
        <MudItem xs="12">
            <MudTextField Variant="Variant.Outlined"
                          Label="Glosa"
                          T="string"
                          @bind-Value="Glosa"
                          Margin="Margin.Dense"/>
        </MudItem>
    </MudGrid>

    <MudStack Row="true" Class="mt-3" Style="align-self: end">
        <MudTooltip Text="Agregar comprobante" Placement="Placement.Bottom">
            <MudFab Color="Color.Success"
                    IconSize="Size.Small"
                    StartIcon="@Icons.Material.Filled.PostAdd"
                    Size="Size.Small"
                    Class="squircle-fab"
                    OnClick="@AgregarComprobante"/>
        </MudTooltip>
        <MudTooltip Text="Agregar detalle" Placement="Placement.Bottom">
            <MudFab Color="Color.Info"
                    IconSize="Size.Small"
                    StartIcon="@Icons.Material.Filled.NoteAdd"
                    Size="Size.Small"
                    DisableElevation="true"
                    Class="squircle-fab"
                    OnClick="OpenAgregarDetalleModal"/>
        </MudTooltip>
    </MudStack>
</MudPaper>
<MudPaper Elevation="1" Class="p-3 mt-3">
    <MudTable Hover="true"
              Striped="true"
              RowsPerPage="3"
              Items="_detalles"
              Dense="true"
              Bordered="true"
              Elevation="2">

        <HeaderContent>
            <MudTh Style="text-align: left">Cuenta</MudTh>
            <MudTh Style="text-align: left">Glosa</MudTh>
            <MudTh Style="text-align: right">Monto Debe</MudTh>
            <MudTh Style="text-align: right">Monto Haber</MudTh>
            <MudTh Style="text-align: center">Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Nombre Cuenta">
                @context.NombreCuenta
            </MudTd>
            <MudTd DataLabel="Glosa">
                @context.Glosa
            </MudTd>
            <MudTd DataLabel="Monto Debe" Style="text-align: right">
                @(context.MontoDebe.ToString("F2"))
            </MudTd>
            <MudTd DataLabel="Monto Haber" Style="text-align: right">
                @context.MontoHaber.ToString("F2")
            </MudTd>
            <MudTd DataLabel="Acciones">
                <MudStack Row="true"
                          Justify="Justify.Center">
                    <MudTooltip Text="Eliminar detalle">
                        <MudIconButton Color="Color.Error"
                                       Icon="@Icons.Material.Filled.DeleteForever"
                                       Size="Size.Small"
                                       OnClick="() => DeleteDetalle(context)"/>
                    </MudTooltip>
                    <MudTooltip Text="Editar detalle">
                        <MudIconButton Color="Color.Warning"
                                       Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       OnClick="() => EditDetalle(context)"/>
                    </MudTooltip>
                </MudStack>
            </MudTd>
        </RowTemplate>
        <FooterContent>
            <MudTd></MudTd>
            <MudTd></MudTd>
            <MudTd Style="text-align: right">
                <MudText Typo="Typo.subtitle2">Total: @TotalDebe.ToString("F2")</MudText>
            </MudTd>
            <MudTd Style="text-align: right">
                <MudText Typo="Typo.subtitle2">Total: @TotalHaber.ToString("F2") </MudText>
            </MudTd>
            <MudTd></MudTd>
        </FooterContent>
    </MudTable>
</MudPaper>
<style>
    .right-aligned-input input {
        text-align: right;
    }

    .squircle-fab {
        border-radius: 30% !important;
        box-shadow: 0 3px 1px -2px rgba(0,0,0,0.2), 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12) !important;
    }
</style>